{% include "header.html" %}
<meta http-equiv="refresh" content="120">
</head>

<body>

<script>
async function deriveKey(akey) {
	akey = await crypto.subtle.importKey(
		'raw',
		(new TextEncoder()).encode(akey),
		{
			'name': 'PBKDF2',
		},
		false,
		['deriveBits', 'deriveKey']
	);
	return await crypto.subtle.deriveKey(
	{
		'name': 'PBKDF2',
		'salt': Uint8Array.from([79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94]),
		'iterations': 7979,
		'hash': 'SHA-512',
	},
	akey,
	{
		'name': 'AES-GCM',
		'length': 256,
	},
	true,
	['encrypt', 'decrypt']);
}
</script>

<script>
async function logIn() {
	var name = document.getElementById('name').value;
	var tooltip = document.getElementById('tooltip');
	if ((name.length < 4) || (name.length > 32)) {
		tooltip.innerHTML = 'Name length ('+name.length+') ∉ [4, 32].';
		tooltip.style.visibility = 'visible';
		return;
	}
	var password = document.getElementById('password').value;
	if ((password.length < 8) || (password.length > 64)) {
		tooltip.innerHTML = 'Password length ('+password.length+') ∉ [8, 64].';
		tooltip.style.visibility = 'visible';
		return;
	}
	var derivedKey = await deriveKey(password);
	var derivedPassword = (await crypto.subtle.exportKey('jwk', derivedKey))['k'];
	var timebomb = '{{ timebomb }}';
	var logInEvent = {'name': name, 'password': derivedPassword, 'timebomb': timebomb};
	var resp = await (await fetch('/login', {
		'method': 'POST',
		'body': JSON.stringify(logInEvent),
		'headers': {'Content-Type': 'application/json'}})).json();
	if (resp['status'] == 'success') {
		tooltip.innerHTML = 'login success.';
		tooltip.style.visibility = 'visible';
		tooltip.style.backgroundColor = '#afa';
		setTimeout(() => window.location.assign('/'), 600);
	}
	else if (resp['status'] == 'fail') {
		tooltip.innerHTML = 'login fail.';
		tooltip.style.visibility = 'visible';
		document.getElementById('name').value = '';
		document.getElementById('password').value = '';
	}
}
</script>

<style>
#tooltip {
	background-color: #ff4545;
	color: #000;
	width: 99%;
	height: 1.2em;
	padding: 2px;
	visibility: hidden;
	opacity: 90%;
	font-weight: bold;
	border: 1px solid #fff;
}
form {
	display: grid;
	grid-template-columns: auto 1fr;
	grid-column-gap: 1em;
	grid-row-gap: 1em;
	margin: 1em;
	width: 40em;
}
</style>

<center>
<div id="tooltip"></div>
<br/><br/>
<form id="login_form" action="">
	<label for="name">name:</label>
	<input id="name" type="text" value=""
		minlength=4 maxlength=32 required/>
	<label for="password">password:</label>
	<input id="password" type="password" value=""
		minlength=8 maxlength=64 required/>
	<div></div>
	<div>
		<input id="login" type="button" value="login" style="width: 6em;" onclick="logIn()">
	</div>
	<div></div>
	<div>
		<button style="width: 6em;" onclick="window.location.assign('/signup')">signup</button>
	</div>
</form>
</center>


</body>
</html>
