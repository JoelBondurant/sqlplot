{% include "header.html" %}
	<script src="https://cdn.jsdelivr.net/npm/d3@7.0.0"></script>
	<link rel="stylesheet" data-name="vs/editor/editor.main" href="https://cdn.jsdelivr.net/npm/monaco-editor@0.25.2/min/vs/editor/editor.main.css">
<style>
#main {
	display: flex;
}
#query_pane {
	flex-grow: 0;
	flex-shrink: 0;
	flex-basis: 100%;
	width: 100%;
	height: 300px;
	border: 1px solid #555;
}
#results_pane {
	flex-grow: 0;
	flex-shrink: 0;
	flex-basis: 100%;
	width: 100%;
	height: 300px;
	border: 1px solid #555;
}
</style>
</head>
<body>

<div id="main" name="main"></div>
<script>
	const querySocket = new WebSocket('ws://127.0.0.1:8080/query_socket');
	querySocket.onmessage = (msg) => {
		console.log(msg);
	}
</script>
<div id="query_pane"
onclick="
	var queryText = window.editor.getValue();
	document.getElementById('query_text').value = queryText;
" autofocus>

<script>
	var require = {"paths":{"vs":"https://cdn.jsdelivr.net/npm/monaco-editor@0.25.2/min/vs"}};
</script>
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.25.2/min/vs/loader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.25.2/min/vs/editor/editor.main.nls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.25.2/min/vs/editor/editor.main.js"></script>
<script>
	window.editor = monaco.editor.create(document.getElementById('query_pane'), {
		value: '',
		language: 'sql',
		fontSize: 14,
		scrollbar: {
			vertical: 'auto',
			horizontal: 'auto'
		},
		theme: 'vs-dark',
		automaticLayout: true,
	});
	const querySession = '{{ query_session }}';
	document.addEventListener('keydown', (event) => {
		if (event.shiftKey && event.key == 'Enter') {
			var event = {
				'query_session': querySession,
				'query_text': window.editor.getValue(),
				'connection_xid': document.getElementById('connection_xid').value,
				'requested': (new Date()).getTime()
			}
			querySocket.send(JSON.stringify(event));
		}
	});
</script>

<script>
async function selectionChanged() {
	var sel = document.getElementById('selection');
	var xid = sel.value;
	var queryText = "";
	var xconnectionId = "";
	if (xid.length == 32) {
		var queryJson = await (await fetch('/query?xid=' + xid)).json();
		queryText = queryJson['query_text'];
		connectionXid = queryJson['connection_xid'];
	}
	document.getElementById('xid').value = xid;
	document.getElementById('query_text').value = queryText;
	document.getElementById('connection_xid').value = connectionXid;
	var name = sel.options[sel.selectedIndex].text;
	document.getElementById('name').value = name;
	window.editor.setValue(queryText);
}
</script>

<br/>
<form name="new" action="query" method="post">
<ul>
	<li class="formrow">
		<label for="name">Name:</label>
		<input id="name" type="text" name="name" value="" required/>
	</li>
	<li class="formrow">
		<label for="connection_xid">Connection:</label>
		<select id="connection_xid" name="connection_xid">
			{% for connection_label in connection_labels: %}
			<option value="{{ connection_label[0] }}">{{ connection_label[1] }}</option>
			{% endfor %}
		</select>
	</li>
	<input type="hidden" id="xid" name="xid" value="">
	<input type="hidden" id="query_text" name="query_text" value="">
</ul>
<input type="submit" value="save">
</form>


<form name="selection" action="">
	<label for="selection">Queries:</label>
	<select name="selection" id="selection" onchange="selectionChanged();">
		<option value="" selected></option>
	{% for query in queries %}
		<option value="{{ query['xid'] }}">{{ query['name'] }}</option>
	{% endfor %}
	</select>
</form>

<br/>
<hr/>

<div id="results_pane" name="results_pane"></div>
<script>
async function renderResults() {

	var csvText = await d3.text('/data/{{ user_xid }}.csv');
	var csv = d3.csvParseRows(csvText);
	
	d3.select('#results_pane').html('');
	var table = d3.select('#results_pane').append('table');
	table.style("border-collapse", "collapse")
		.style("border", "2px white solid")
		.style("background-color", "#1e1e1e");

	table.append("thead").append("tr")
		.selectAll("th")
		.data(csv[0])
		.enter().append("th")
		.text(function(d) { return d; })
		.style("border", "1px white solid")
		.style("padding", "5px")
		.style("color", "white")
		.style("background-color", "#222")
		.style("font-weight", "bold")
		.style("text-transform", "uppercase");

	table.append("tbody")
		.selectAll("tr").data(csv.slice(1))
		.enter().append("tr")
		.selectAll("td")
		.data(function(d){return d;})
		.enter().append("td")
		.style("border", "1px white solid")
		.style("color", "white")
		.style("padding", "5px")
		.on("mouseover", function(){
			d3.select(this).style("background-color", "#444");
		})
		.on("mouseout", function(){
			d3.select(this).style("background-color", "#222");
		})
		.text(function(d){return d;})
		.style("font-size", "12px");

}
</script>
<script>
	const resultsSocket = new WebSocket('ws://127.0.0.1:8080/results_socket');
	resultsSocket.onopen = async () => {
		var event = {
			'type': 'results',
			'query_session': querySession,
		}
		resultsSocket.send(JSON.stringify(event));
	}
	resultsSocket.onmessage = async (msg) => {
		var resultStatus = JSON.parse(msg.data)['status'];
		if (resultStatus == 'ready') {
			await renderResults();
		}
	}
</script>

</body>
</html>
